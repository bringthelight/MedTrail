{% extends "dashboard.html" %}

{% block title %}Generate Bill{% endblock %}

{% block content %}
<div class="container mt-7 px-7 py-5 float-end">
    <div class="card ">
        <div class="card-header bg-gradient-primary text-white">
            <h4 class="mb-0">Generate Bill</h4>
        </div>
        <div class="card-body">
            <form>
                <!-- Dynamic Medicine Selection Fields -->
                <!-- Replace the medicine-entry div with this -->
                <div class="medicine-entry row mb-3 d-flex align-items-center">
                    <div class="col-md-3">
                        <label class="form-label">Medicine Name</label>
                        <select class="form-select medicine-select" name="medicines[]" required>
                            <option value="">Select Medicine</option>
                            {% for med in med_names %}
                            <option value="{{ med.id }}" data-price="{{ med.price }}"
                                data-discount="{{ med.discount }}">
                                {{ med.ratelist_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control quantity-input" name="quantities[]" min="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Amount</label>
                        <input type="text" class="form-control amount-display" name="amounts[]" readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Discount (%)</label>
                        <input type="text" class="form-control discount-display" name="discounts[]" readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Net Amount</label>
                        <input type="text" class="form-control net-amount-display" name="net_amounts[]" readonly>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="button" class="btn btn-danger remove-medicine" style="display: none;">
                            <i class="bi bi-dash-circle"></i>
                        </button>
                    </div>
                </div>

                <!-- Replace the script block with this updated version -->

                <!-- Add Medicine Button -->
                <div class="mb-3">
                    <button type="button" class="btn bg-gradient-primary" id="addMedicine">
                        <i class="bi bi-plus-circle"></i> Add Medicine
                    </button>
                </div>

                <!-- Bill Summary -->
                <!-- <div class="card mt-4">
                    <div class="card-header bg-gradient-secondary text-white">
                        <h5 class="mb-0">Bill Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Total Items:</strong> <span id="totalItems">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Amount:</strong> â‚¹<span id="totalAmount">0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div> -->

                <!-- Submit Button -->
                <div class="text-end mt-4">
                    <button type="submit" class="btn bg-gradient-primary" id="generateBill">
                        <i class="bi bi-printer"></i> Generate Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const medicineFields = document.getElementById('medicineFields');
        const addButton = document.getElementById('addMedicine');
        const form = document.getElementById('billForm');

        // Calculate row totals
        function calculateRowTotals(entry) {
            const select = entry.querySelector('.medicine-select');
            const quantity = parseInt(entry.querySelector('.quantity-input').value) || 0;
            const selectedOption = select.selectedOptions[0];

            if (selectedOption && selectedOption.value) {
                const price = parseFloat(selectedOption.dataset.price) || 0;
                const discountPercent = parseFloat(selectedOption.dataset.discount) || 0;

                const amount = price * quantity;
                const discount = (amount * discountPercent) / 100;
                const netAmount = amount - discount;

                entry.querySelector('.amount-display').value = amount.toFixed(2);
                entry.querySelector('.discount-display').value = discountPercent.toFixed(2);
                entry.querySelector('.net-amount-display').value = netAmount.toFixed(2);

                return { quantity, amount, netAmount };
            }
            return { quantity: 0, amount: 0, netAmount: 0 };
        }

        // Update all totals
        function updateTotals() {
            const entries = document.querySelectorAll('.medicine-entry');
            let totalItems = 0;
            let totalAmount = 0;
            let totalNetAmount = 0;

            entries.forEach(entry => {
                const totals = calculateRowTotals(entry);
                totalItems += totals.quantity;
                totalAmount += totals.netAmount;
            });

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('totalAmount').textContent = totalAmount.toFixed(2);

            // Show/hide remove buttons
            const removeButtons = document.querySelectorAll('.remove-medicine');
            removeButtons.forEach((btn, index) => {
                btn.style.display = entries.length > 1 ? 'block' : 'none';
            });
        }

        // Add new medicine entry
        addButton.addEventListener('click', function () {
            const entry = document.querySelector('.medicine-entry').cloneNode(true);
            entry.querySelector('.medicine-select').value = '';
            entry.querySelector('.quantity-input').value = '';
            entry.querySelector('.amount-display').value = '';
            entry.querySelector('.discount-display').value = '';
            entry.querySelector('.net-amount-display').value = '';
            entry.querySelector('.remove-medicine').style.display = 'block';
            medicineFields.appendChild(entry);
            updateTotals();
        });

        // Remove medicine entry
        medicineFields.addEventListener('click', function (e) {
            const removeButton = e.target.closest('.remove-medicine');
            if (removeButton) {
                const entries = document.querySelectorAll('.medicine-entry');
                if (entries.length > 1) {
                    removeButton.closest('.medicine-entry').remove();
                    updateTotals();
                }
            }
        });

        // Update calculations on medicine selection or quantity change
        medicineFields.addEventListener('change', function (e) {
            if (e.target.classList.contains('medicine-select') ||
                e.target.classList.contains('quantity-input')) {
                updateTotals();
            }
        });

        medicineFields.addEventListener('input', function (e) {
            if (e.target.classList.contains('quantity-input')) {
                updateTotals();
            }
        });

        // Form validation
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const medicines = document.querySelectorAll('.medicine-select');
            let hasSelection = false;

            medicines.forEach(select => {
                if (select.value) hasSelection = true;
            });

            if (!hasSelection) {
                alert('Please select at least one medicine');
                return;
            }

            this.submit();
        });
    });
</script>
{% endblock %}