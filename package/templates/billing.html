{% extends "dashboard.html" %}

{% block title %}Generate Bill{% endblock %}

{% block content %}
<div class="container mt-7 px-7 py-5 float-end">
    <div class="card">
        <div class="card-header bg-gradient-primary text-white">
            <h4 class="mb-0">Generate Bill</h4>
        </div>
        <div class="card-body">
            <form id="billForm">
                <div id="medicineRows">
                    <div class="medicine-row row mb-3">
                        <div class="col-md-3">
                            <label class="form-label">Medicine Name</label>
                            <select class="form-select medicine-select" name="medicine[]" required>
                                <option value="">Select Medicine</option>
                                {% for med in med_names %}
                                <option value="{{ med.id }}" 
                                        data-price="{{ med.amount }}" 
                                        data-discount="{{ med.discount }}">
                                    {{ med.ratelist_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control quantity" name="quantity[]" min="1" value="1" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Amount</label>
                            <input type="text" class="form-control amount" name="amount[]" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Discount (%)</label>
                            <input type="text" class="form-control discount" name="discount[]" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Net Amount</label>
                            <input type="text" class="form-control net-amount" name="net_amount[]" readonly>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger remove-row mt-4" style="display: none;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <button type="button" class="btn bg-gradient-primary" id="addRow">
                        <i class="bi bi-plus-circle"></i> Add Medicine
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-gradient-secondary text-white">
                        <h5 class="mb-0">Bill Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Total Items:</strong> <span id="totalItems">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Amount:</strong> â‚¹<span id="totalAmount">0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn bg-gradient-primary">
                        <i class="bi bi-printer"></i> Generate Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Test log to verify script is running
        console.log('Script initialized');
        
        // Get the add row button
        const addRowBtn = document.getElementById('addRow');
        const form = document.getElementById('billForm');
        
        // Log to verify elements are found
        console.log('Add Row Button found:', !!addRowBtn);
        console.log('Form found:', !!form);
        
        // Add row button click event
        if (addRowBtn) {
            addRowBtn.addEventListener('click', function() {
                console.log('Add Row button clicked');
                addNewRow();
            });
        }
        
        // Form submission
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted');
                generateBill();
            });
        }
        
        // Initial setup
        setupEventListeners();
        calculateAllRows();
        updateRemoveButtons();
    });
    
    // Function to add a new row
    function addNewRow() {
        // Get the container and first row
        const container = document.getElementById('medicineRows');
        const firstRow = document.querySelector('.medicine-row');
        
        if (container && firstRow) {
            // Clone the first row
            const newRow = firstRow.cloneNode(true);
            
            // Reset values
            const selects = newRow.querySelectorAll('select');
            const inputs = newRow.querySelectorAll('input');
            
            selects.forEach(select => select.selectedIndex = 0);
            inputs.forEach(input => {
                if (input.type === 'number') {
                    input.value = '1'; // Default quantity
                } else {
                    input.value = '';
                }
            });
            
            // Add to container
            container.appendChild(newRow);
            console.log('New row added');
            
            // Update the UI
            setupEventListeners();
            updateRemoveButtons();
        } else {
            console.error('Container or row template not found');
        }
    }
    
    // Setup event listeners for dynamic elements
    function setupEventListeners() {
        // Medicine selection change
        document.querySelectorAll('.medicine-select').forEach(select => {
            select.addEventListener('change', function() {
                console.log('Medicine selected');
                calculateRow(this.closest('.medicine-row'));
            });
        });
        
        // Quantity change
        document.querySelectorAll('.quantity').forEach(input => {
            input.addEventListener('input', function() {
                console.log('Quantity changed');
                calculateRow(this.closest('.medicine-row'));
            });
        });
        
        // Remove row buttons
        document.querySelectorAll('.remove-row').forEach(button => {
            button.addEventListener('click', function() {
                console.log('Remove button clicked');
                if (document.querySelectorAll('.medicine-row').length > 1) {
                    this.closest('.medicine-row').remove();
                    updateRemoveButtons();
                    calculateTotals();
                }
            });
        });
    }
    
    // Calculate values for a single row
    function calculateRow(row) {
        if (!row) return;
        
        const select = row.querySelector('.medicine-select');
        const quantityInput = row.querySelector('.quantity');
        const amountInput = row.querySelector('.amount');
        const discountInput = row.querySelector('.discount');
        const netAmountInput = row.querySelector('.net-amount');
        
        if (select && quantityInput && amountInput && discountInput && netAmountInput) {
            const selectedOption = select.options[select.selectedIndex];
            const quantity = parseInt(quantityInput.value) || 0;
            
            let price = 0;
            let discount = 0;
            
            if (selectedOption && selectedOption.value) {
                price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
                discount = parseFloat(selectedOption.getAttribute('data-discount')) || 0;
            }
            
            const amount = price * quantity;
            const discountAmount = (amount * discount) / 100;
            const netAmount = amount - discountAmount;
            
            amountInput.value = amount.toFixed(2);
            discountInput.value = discount.toFixed(2);
            netAmountInput.value = netAmount.toFixed(2);
            
            console.log('Row calculated:', { price, quantity, discount, amount, netAmount });
        }
        
        calculateTotals();
    }
    
    // Calculate all rows (for initial load)
    function calculateAllRows() {
        document.querySelectorAll('.medicine-row').forEach(row => {
            calculateRow(row);
        });
    }
    
    // Update totals
    function calculateTotals() {
        let totalItems = 0;
        let totalAmount = 0;
        
        document.querySelectorAll('.medicine-row').forEach(row => {
            const quantityInput = row.querySelector('.quantity');
            const netAmountInput = row.querySelector('.net-amount');
            
            if (quantityInput && netAmountInput) {
                const quantity = parseInt(quantityInput.value) || 0;
                const netAmount = parseFloat(netAmountInput.value) || 0;
                
                totalItems += quantity;
                totalAmount += netAmount;
            }
        });
        
        const totalItemsElement = document.getElementById('totalItems');
        const totalAmountElement = document.getElementById('totalAmount');
        
        if (totalItemsElement) totalItemsElement.textContent = totalItems;
        if (totalAmountElement) totalAmountElement.textContent = totalAmount.toFixed(2);
        
        console.log('Totals updated:', { totalItems, totalAmount });
    }
    
    // Update remove buttons visibility
    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.medicine-row');
        const buttons = document.querySelectorAll('.remove-row');
        
        buttons.forEach(button => {
            button.style.display = rows.length > 1 ? 'block' : 'none';
        });
        
        console.log('Remove buttons updated, row count:', rows.length);
    }
    
    // Generate the bill
    function generateBill() {
        const billData = {
            items: [],
            summary: {
                totalItems: document.getElementById('totalItems').textContent,
                totalAmount: document.getElementById('totalAmount').textContent
            }
        };
        
        document.querySelectorAll('.medicine-row').forEach(row => {
            const select = row.querySelector('.medicine-select');
            const quantityInput = row.querySelector('.quantity');
            
            if (select && quantityInput && select.value) {
                const selectedOption = select.options[select.selectedIndex];
                
                billData.items.push({
                    medicine_id: select.value,
                    medicine_name: selectedOption.textContent.trim(),
                    quantity: quantityInput.value,
                    amount: row.querySelector('.amount').value,
                    discount: row.querySelector('.discount').value,
                    net_amount: row.querySelector('.net-amount').value
                });
            }
        });
        
        console.log('Bill Data:', billData);
        console.log('Bill Data JSON:', JSON.stringify(billData, null, 2));
        
        // Show bill data in alert (for testing)
        alert('Bill Generated!\n\n' + JSON.stringify(billData, null, 2));
        
        return billData;
    }
    </script>

{% endblock %}

