{% extends "dashboard.html" %}

{% block title %}Generate Bill{% endblock %}

{% block content %}
<div class="container mt-7 px-7 py-5 float-end">
    <div class="card">
        <div class="card-header bg-gradient-primary text-white">
            <h4 class="mb-0">Generate Bill</h4>
        </div>
        <div class="card-body">
            <form id="billForm">
                <div id="medicineRows">
                    <div class="medicine-row row mb-3">
                        <div class="col-md-2">
                            <label class="form-label">Medicine Name</label>
                            <div class="dropdown-container position-relative">
                                <input type="text" class="form-control medicine-search" placeholder="Search medicine..." id="medicineSearchInput">
                                <div class="dropdown-list position-absolute w-100 d-none" id="medicineDropdown" style="max-height: 300px; overflow-y: auto; z-index: 1000; background: white; border: 1px solid #ced4da; border-radius: 0.25rem;">
                                    <!-- Options will be populated here dynamically -->
                                </div>
                                <select class="form-select medicine-select d-none" name="medicine[]" required id="actualMedicineSelect">
                                    <option value="">Select Medicine</option>
                                    {% for med in med_names %}
                                    <option value="{{ med.id }}" 
                                            data-price="{{ med.amount }}" 
                                            data-discount="{{ med.discount }}">
                                        {{ med.ratelist_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="medicine[]" id="selectedMedicineId" required>
                            </div>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Quantity</label>
                            <input style="padding: 8px;" type="number" class="form-control quantity" name="quantity[]" value="1" min="1" required>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Price</label>
                            <input type="text" class="form-control amount" name="amount[]" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Discount%</label>
                            <input  type="text" class="form-control discount" name="discount[]" readonly>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Special Discount%</label>
                            <input type="number" class="form-control special-discount" name="special_discount[]" value="" min="0" max="100">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Net Amount</label>
                            <input type="text" class="form-control net-amount" name="net_amount[]" readonly>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger remove-row mt-4" style="display: none;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <button type="button" class="btn bg-gradient-primary" id="addRow">
                        <i class="bi bi-plus-circle"></i> Add Medicine
                    </button>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-gradient-secondary text-white">
                        <h5 class="mb-0">Bill Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Total Items:</strong> <span id="totalItems">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Total Amount:</strong> â‚¹<span id="totalAmount">0.00</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn bg-gradient-primary">
                        <i class="bi bi-printer"></i> Generate Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Test log to verify script is running
        console.log('Script initialized');
        
        // Get the add row button
        const addRowBtn = document.getElementById('addRow');
        const form = document.getElementById('billForm');
        
        // Log to verify elements are found
        console.log('Add Row Button found:', !!addRowBtn);
        console.log('Form found:', !!form);
        
        // Add row button click event
        if (addRowBtn) {
            addRowBtn.addEventListener('click', function() {
                console.log('Add Row button clicked');
                addNewRow();
            });
        }
        
        // Form submission
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('Form submitted');
                generateBill();
            });
        }
        
        // Initial setup
        initializeSearchableDropdowns();
        setupEventListeners();
        calculateAllRows();
        updateRemoveButtons();
    });
    
    // Initialize searchable dropdowns for all medicine rows
    function initializeSearchableDropdowns() {
        document.querySelectorAll('.medicine-row').forEach(row => {
            setupSearchableDropdown(row);
        });
    }
    
    // Setup searchable dropdown for a specific row
    function setupSearchableDropdown(row) {
        const searchInput = row.querySelector('.medicine-search');
        const dropdown = row.querySelector('.dropdown-list');
        const actualSelect = row.querySelector('.medicine-select');
        const hiddenInput = row.querySelector('input[type="hidden"]');
        
        if (!searchInput || !dropdown || !actualSelect || !hiddenInput) return;
        
        // Create medicine options array from select options
        const medicines = [];
        for (let i = 1; i < actualSelect.options.length; i++) { // Start from 1 to skip the "Select Medicine" option
            const option = actualSelect.options[i];
            medicines.push({
                id: option.value,
                name: option.textContent.trim(),
                price: option.dataset.price,
                discount: option.dataset.discount
            });
        }
        
        // Function to populate dropdown with filtered items
        function populateDropdown(filter = '') {
            dropdown.innerHTML = '';
            const filterLower = filter.toLowerCase();
            
            // Always add a "Select Medicine" option
            const defaultOption = document.createElement('div');
            defaultOption.className = 'dropdown-item p-2';
            defaultOption.textContent = 'Select Medicine';
            defaultOption.dataset.id = '';
            defaultOption.style.cursor = 'pointer';
            dropdown.appendChild(defaultOption);
            
            // Add matching medicines
            const matchingMedicines = medicines.filter(med => 
                med.name.toLowerCase().includes(filterLower)
            );
            
            matchingMedicines.forEach(medicine => {
                const item = document.createElement('div');
                item.className = 'dropdown-item p-2';
                item.textContent = medicine.name;
                item.dataset.id = medicine.id;
                item.dataset.price = medicine.price;
                item.dataset.discount = medicine.discount;
                item.style.cursor = 'pointer';
                dropdown.appendChild(item);
            });
            
            // Show no results message if no matches found
            if (matchingMedicines.length === 0 && filter !== '') {
                const noResults = document.createElement('div');
                noResults.className = 'p-2 text-muted';
                noResults.textContent = 'No medicines found';
                dropdown.appendChild(noResults);
            }
        }
        
        // Initialize dropdown with all options
        populateDropdown();
        
        // Show dropdown when input is focused
        searchInput.addEventListener('focus', function() {
            dropdown.classList.remove('d-none');
        });
        
        // Filter as user types
        searchInput.addEventListener('input', function() {
            populateDropdown(this.value);
            dropdown.classList.remove('d-none');
        });
        
        // Handle item selection
        dropdown.addEventListener('click', function(event) {
            if (event.target.classList.contains('dropdown-item')) {
                const id = event.target.dataset.id;
                const name = event.target.textContent;
                const price = event.target.dataset.price;
                const discount = event.target.dataset.discount;
                
                // Update hidden input with selected value
                hiddenInput.value = id;
                
                // Update search input with selected name
                searchInput.value = name;
                
                // Set validation state
                if (id) {
                    // searchInput.classList.add('is-valid');
                    // searchInput.classList.remove('is-invalid');
                    
                    // Update actual select to match (for calculation compatibility)
                    actualSelect.value = id;
                    
                    // Recalculate the row
                    calculateRow(row);
                } else {
                    searchInput.value = '';
                    searchInput.classList.remove('is-valid');
                    actualSelect.selectedIndex = 0;
                    calculateRow(row);
                }
                
                // Hide dropdown
                dropdown.classList.add('d-none');
            }
        });
        
        // Handle clicking outside to close dropdown
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-container') || event.target.closest('.dropdown-container') !== searchInput.closest('.dropdown-container')) {
                dropdown.classList.add('d-none');
            }
        });
    }
    
    // Function to add a new row
    function addNewRow() {
        // Get the container and first row
        const container = document.getElementById('medicineRows');
        const firstRow = document.querySelector('.medicine-row');
        
        if (container && firstRow) {
            // Clone the first row
            const newRow = firstRow.cloneNode(true);
            
            // Reset values
            const selects = newRow.querySelectorAll('select');
            const inputs = newRow.querySelectorAll('input');
            
            selects.forEach(select => select.selectedIndex = 0);
            inputs.forEach(input => {
                if (input.type === 'number' && input.classList.contains('quantity')) {
                    input.value = '1'; // Default quantity
                } else if (input.type === 'number' && input.classList.contains('special-discount')) {
                    input.value = '0'; // Default special discount
                } else {
                    input.value = '';
                }
            });
            
            // Reset search input
            const searchInput = newRow.querySelector('.medicine-search');
            if (searchInput) searchInput.value = '';
            
            // Add to container
            container.appendChild(newRow);
            console.log('New row added');
            
            // Setup searchable dropdown for the new row
            setupSearchableDropdown(newRow);
            
            // Update the UI
            setupEventListeners();
            updateRemoveButtons();
        } else {
            console.error('Container or row template not found');
        }
    }
    
    // Setup event listeners for dynamic elements
    function setupEventListeners() {
        // Medicine selection change (through hidden input for searchable dropdown)
        document.querySelectorAll('input[name="medicine[]"]').forEach(input => {
            input.addEventListener('change', function() {
                console.log('Medicine selected (hidden input)');
                calculateRow(this.closest('.medicine-row'));
            });
        });
        
        // Original medicine select (kept for compatibility)
        document.querySelectorAll('.medicine-select').forEach(select => {
            select.addEventListener('change', function() {
                console.log('Medicine selected (original)');
                calculateRow(this.closest('.medicine-row'));
            });
        });
        
        // Quantity change
        document.querySelectorAll('.quantity').forEach(input => {
            input.addEventListener('input', function() {
                console.log('Quantity changed');
                calculateRow(this.closest('.medicine-row'));
            });
        });
        
        // Special discount change
        document.querySelectorAll('.special-discount').forEach(input => {
            input.addEventListener('input', function() {
                console.log('Special discount changed');
                calculateRow(this.closest('.medicine-row'));
            });
        });
        
        // Remove row buttons
        document.querySelectorAll('.remove-row').forEach(button => {
            button.addEventListener('click', function() {
                console.log('Remove button clicked');
                if (document.querySelectorAll('.medicine-row').length > 1) {
                    this.closest('.medicine-row').remove();
                    updateRemoveButtons();
                    calculateTotals();
                }
            });
        });
    }
    
    // Calculate values for a single row
   function calculateRow(row) {
    if (!row) return;

    const select = row.querySelector('.medicine-select');
    const hiddenInput = row.querySelector('input[name="medicine[]"]');
    const quantityInput = row.querySelector('.quantity');
    const amountInput = row.querySelector('.amount');
    const discountInput = row.querySelector('.discount');
    const specialDiscountInput = row.querySelector('.special-discount'); 
    const netAmountInput = row.querySelector('.net-amount');

    if (quantityInput && amountInput && discountInput && specialDiscountInput && netAmountInput) {
        let price = 0;
        let discount = 0;
        let selectedOption = null;

      
        if (hiddenInput && hiddenInput.value) {
            if (select) {
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === hiddenInput.value) {
                        selectedOption = select.options[i];
                        break;
                    }
                }
            }
        } else if (select) {
            selectedOption = select.options[select.selectedIndex];
        }

        const quantity = parseInt(quantityInput.value) || 0;
        const specialDiscount = parseFloat(specialDiscountInput.value) || 0; 

        if (selectedOption && selectedOption.value) {
            price = parseFloat(selectedOption.getAttribute('data-price')) || 0;
            discount = parseFloat(selectedOption.getAttribute('data-discount')) || 0;
        }

        const amount = price * quantity;
        const regularDiscountAmount = (amount * discount) / 100; 
        const netAmount = amount - regularDiscountAmount - specialDiscount; 

        amountInput.value = amount.toFixed(2);
        discountInput.value = discount.toFixed(2);
        netAmountInput.value = netAmount.toFixed(2);

        console.log('Row calculated:', {
            price,
            quantity,
            discount,
            specialDiscount,
            amount,
            regularDiscountAmount,
            netAmount
        });
    }

    calculateTotals(); 
}

    
    // Calculate all rows (for initial load)
    function calculateAllRows() {
        document.querySelectorAll('.medicine-row').forEach(row => {
            calculateRow(row);
        });
    }
    
    // Update totals
    function calculateTotals() {
        let totalItems = 0;
        let totalAmount = 0;
        
        document.querySelectorAll('.medicine-row').forEach(row => {
            const quantityInput = row.querySelector('.quantity');
            const netAmountInput = row.querySelector('.net-amount');
            
            if (quantityInput && netAmountInput) {
                const quantity = parseInt(quantityInput.value) || 0;
                const netAmount = parseFloat(netAmountInput.value) || 0;
                
                totalItems += quantity;
                totalAmount += netAmount;
            }
        });
        
        const totalItemsElement = document.getElementById('totalItems');
        const totalAmountElement = document.getElementById('totalAmount');
        
        if (totalItemsElement) totalItemsElement.textContent = totalItems;
        if (totalAmountElement) totalAmountElement.textContent = totalAmount.toFixed(2);
        
        console.log('Totals updated:', { totalItems, totalAmount });
    }
    
    // Update remove buttons visibility
    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.medicine-row');
        const buttons = document.querySelectorAll('.remove-row');
        
        buttons.forEach(button => {
            button.style.display = rows.length > 1 ? 'block' : 'none';
        });
        
        console.log('Remove buttons updated, row count:', rows.length);
    }
    
    // Generate the bill
    function generateBill() {
        const billData = {
            items: [],
            summary: {
                totalItems: document.getElementById('totalItems').textContent,
                totalAmount: document.getElementById('totalAmount').textContent
            }
        };
        
        document.querySelectorAll('.medicine-row').forEach(row => {
            const hiddenInput = row.querySelector('input[name="medicine[]"]');
            const searchInput = row.querySelector('.medicine-search');
            const quantityInput = row.querySelector('.quantity');
            const specialDiscountInput = row.querySelector('.special-discount');
            
            if (hiddenInput && hiddenInput.value && quantityInput) {
                billData.items.push({
                    medicine_id: hiddenInput.value,
                    medicine_name: searchInput ? searchInput.value : "Unknown Medicine",
                    quantity: quantityInput.value,
                    amount: row.querySelector('.amount').value,
                    discount: row.querySelector('.discount').value,
                    special_discount: specialDiscountInput ? specialDiscountInput.value : "0",
                    net_amount: row.querySelector('.net-amount').value
                });
            }
        });
        
        console.log('Bill Data:', billData);
        console.log('Bill Data JSON:', JSON.stringify(billData, null, 2));
        
        // Show bill data in alert (for testing)
        alert('Bill Generated!\n\n' + JSON.stringify(billData, null, 2));
        
        return billData;
    }
    </script>

{% endblock %}

